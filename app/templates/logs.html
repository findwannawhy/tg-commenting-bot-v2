<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Логи</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<style>
		:root{ --bg:#0b0c10; --panel:#111318; --muted:#8b95a7; --text:#e7eaf0; --border:#1d2230; }
		*{ box-sizing: border-box; }
		body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
		.container{ max-width: 1000px; margin: 0 auto; padding: 24px; }
		.nav{ display:flex; gap:10px; align-items-center; margin-bottom: 18px; }
		.nav a{ color:var(--muted); text-decoration:none; padding:8px 10px; border-radius:8px; }
		.nav a:hover{ background:var(--panel); color:var(--text); }
		h1{ font-size:22px; margin: 8px 0 16px; }
		pre{ background:#0e0f14; color:#c8d1e6; padding:12px; height:70vh; overflow:auto; border:1px solid var(--border); border-radius:12px; white-space: pre-wrap; }
		.header-monke {
			margin-left: auto;
		}
		.header-monke img {
			height: 44px;
			width: auto;
			border-radius: 6px;
			display: block;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="nav">
			<a href="/">Панель</a>
			<a href="/channels">Каналы</a>
			<a href="/settings">Настройки</a>
			<a href="/logs">Логи</a>
			<a href="/auth">Авторизация</a>
			<a href="/monke" class="header-monke"><img src="/static/monke.gif" alt="monke"></a>
		</div>
		<h1>Логи</h1>
		<pre id="log">{% for line in lines %}{{ line }}
{% endfor %}</pre>
	</div>
	<script>
	(function() {
		let es = null;

		function connectStream() {
			if (es) {
				es.close();
			}
			const pre = document.getElementById('log');
			// With cookie-based auth, we don't need to pass the token.
			// The browser will send the cookie automatically.
			es = new EventSource('/logs/stream', { withCredentials: false });
			es.onmessage = (ev) => {
				pre.textContent += ev.data + '\n';
				pre.scrollTop = pre.scrollHeight;
			};
			es.onerror = () => {
				// If the connection is closed by the server (e.g., auth failure),
				// the browser will try to reconnect. Let's check if our session is still valid.
				fetch('/health').then(response => {
					if (response.status === 401) {
						window.location.href = '/enter-token';
					}
				});
			};
		}

		window.onload = () => {
			const pre = document.getElementById('log');
			pre.scrollTop = pre.scrollHeight;
			connectStream();
		};
	})();
	</script>
</body>
</html>
